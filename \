import speakeasy from "speakeasy";
import Qrcode from "qrcode";
import { PrismaClient } from "../../generate/prisma";
import CryptoJS from "crypto-js";

const prisma = new PrismaClient();

export const generate2FASetup = async (userId: string, userEmail: string) => {
  try {
    const secret = speakeasy.generateSecret({
      length: 20,
      name: `TaskFlow (${userEmail})`,
      issuer: "TaskFlow",
    });

    const otpath_url = speakeasy.otpauthURL({
      secret: secret.base32,
      label: userEmail,
      issuer: "TaskFlow",
    });

    const qrCodeDataURL = await Qrcode.toDataURL(otpath_url);

    const backupCodes = Array.from({ length: 7 }, () => {
      return Math.random().toString(36).slice(-8).toUpperCase();
    });

    // const encryptedSecret = CryptoJS.AES.encrypt(
    //   secret.base32!,
    //   process.env.ENCRYPTION_KEY!,
    // ).toString();
    //
    // const encryptedBackupCodes = CryptoJS.AES.encrypt(
    //   JSON.stringify(backupCodes),
    //   process.env.ENCRYPTION_KEY!,
    // ).toString();

    return {
      qrCodeDataURL,
      manualEntryCode: secret.base32,
      backupCodes,
      // encryptedSecret,
      // encryptedBackupCodes,
    };
  } catch (error: any) {
    throw new Error("2FA setup failed: " + error.message);
  }
};
export const verify2FAWithOTP = async (
  userId: string,
  tempEncryptedSecret: string,
  otpCode: string,
) => {
  if (!process.env.ENCRYPTION_KEY) {
    throw new Error("Encryption key not configured");
  }
};
