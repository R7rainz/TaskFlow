import { Request, Response, NextFunction } from "express";
import { PrismaClient } from "../../generate/prisma";
import { setup2FA } from "../services/twoFactorService";

const prisma = new PrismaClient();

export const setup2FAController = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    // Get userId from req.user and using this, get user email from DB
    const userId = (req as any).user.userId;

    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { email: true },
    });
    if (!user) {
      return res.status(404).json({ message: "User not found" });
    }

    // 3. Call setup2FA service
    const result = await setup2FA(userId.toString(), user.email);

    // 4. Decide what to return to frontend
    res.json({
      qrCode: result.qrCodeDataURL,
      manualEntryCode: result.manualEntryCode,
      backupCodes: result.backupCodes,
    });
  } catch (error: unknown) {
    next(error);
  }
};

export const verify2FAController = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const userId = (req as any).user.userId;
  const { otpCode, tempEncryptedSecret } = req.body;

  await verifyAndEnable2FA(userId.toString(), tempEncryptedSecret, otpCode);
  res.json({ message: "2FA enabled successfully"})
};
